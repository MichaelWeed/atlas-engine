{
    "TemplateBody": "AWSTemplateFormatVersion: 2010-09-09\nDescription: |\n    Master Lex Web UI CloudFormation template (v0.22.5)\n    The Lex Web Ui can be deployed to operate against either a Lex V2 Bot OR a Lex V1 Bot BUT NOT BOTH.\n    Please configure either the Lex V2 bot information OR the Lex V1 bot information and leave the other\n    version input parameters as defaulted.\n    A deployment of Lex Web Ui can not be switched between V2 and V1 by updating the stack with different parameters.\n    It deploys:\n        - S3 buckets to host the web application\n        - CodeBuild project to build the configuration and deploy to S3\n        - Optional Lex Bot (based on OrderFlowers example)\n        - Optional Cognito Identity Pool for unauthenticated identities\n        - Optional Lambda function to delete S3 buckets\n        - CloudWatch Logs groups related to Lambda functions\n        - Associated IAM roles\n\nParameters:\n    LexV2BotId:\n        Description: >\n            Bot ID (not bot name) of an existing Lex V2 Bot to be used by the web ui. NOTE: You must\n            also enter your Bot alias ID in the LexV2BotAliasId field below. DO NOT MODIFY this value if\n            configuring a V1 Bot.\n        Type: String\n        Default: ''\n        MaxLength: 50\n        AllowedPattern: '(^$|^[a-zA-Z0-9]+((_[a-zA-Z0-9]+)*|([a-zA-Z0-9]+_)*|_))'\n        ConstraintDescription: >\n            Must conform with the permitted Lex V2 Bot name pattern.\n\n    LexV2BotAliasId:\n        Description: >\n            Use your Lex V2 Bot's alias id (not alias name) here. DO NOT MODIFY this value if\n            configuring a V1 Bot.\n        Type: String\n        Default: ''\n        MinLength: 0\n        MaxLength: 50\n        AllowedPattern: '(^$|^[$a-zA-Z0-9]+((_[$a-zA-Z0-9]+)*|([$a-zA-Z0-9]+_)*|_))'\n        ConstraintDescription: >\n            Must conform with the permitted Lex V2 Alias name pattern.\n\n    LexV2BotLocaleId:\n        Description: >\n            Specify your bot's supported locale ids. By default this list contains only en_US. Other Lex V2\n            supported values are de_DE, en_AU, en_GB, es_419, es_ES, es_US, fr_CA, fr_FR, it_IT, ja_JP. A comma\n            separated list of values can be supplied with the first value in the list being the default value. The\n            remaining items can be selected in the Lex Web Ui menu.\n            See \"https://docs.aws.amazon.com/lexv2/latest/dg/lex2.0.pdf\"\n            for details on supported languages and locales. DO NOT MODIFY this value if\n            configuring a V1 Bot.\n        Type: String\n        Default: 'en_US'\n        MinLength: 2\n        MaxLength: 50\n\n    BotName:\n        Description: >\n            Name of an existing Lex Bot to be used by the web ui. NOTE: You must\n            also enter your published bot alias in the BotAlias field below. DO NOT MODIFY this value if\n            configuring a V2 Bot.\n        Type: String\n        Default: ''\n        MinLength: 0\n        MaxLength: 50\n        AllowedPattern: '(^$|^[a-zA-Z]+((_[a-zA-Z]+)*|([a-zA-Z]+_)*|_))'\n        ConstraintDescription: >\n            Must conform with the permitted Lex Bot name pattern.\n\n    BotAlias:\n        Description: >\n            WARNING: For production deployments, use your bot's published alias here.\n            The $LATEST alias should only be used for manual testing. Amazon Lex limits\n            the number of runtime requests that you can make to the $LATEST version of\n            the bot. DO NOT MODIFY this value if configuring a V2 Bot.\n        Type: String\n        Default: '$LATEST'\n        MinLength: 2\n        MaxLength: 50\n        AllowedPattern: '(^$|^[$a-zA-Z]+((_[$a-zA-Z]+)*|([$a-zA-Z]+_)*|_))'\n        ConstraintDescription: >\n            Must conform with the permitted Lex Alias name pattern.\n\n    ShouldDeleteBot:\n        Type: String\n        Default: true\n        AllowedValues:\n          - true\n          - false\n        Description: >\n            If set to True, the Optional Sample Lex bot and associated resources will\n            be deleted when the stack is deleted. Otherwise, the bot\n            will be preserved. Only applies if the bot is created by\n            this stack.\n\n    EnableCognitoLogin:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n            If set to True, a menu with a login action will be displayed\n            in the Lex Web Ui. This feature uses Cognito User Pools with\n            hosted login pages. After login, the menu will switch to logout.\n\n    ForceCognitoLogin:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n            If set to True, the menu with a login action will not be displayed\n            in the Lex Web Ui, and the Cognito login will be executed automatically. This implicitly sets\n            EnableCognitoLogin to be true.\n\n    AllowedSignUpEmailDomain:\n        Type: String\n        Default: ''\n        Description: >-\n            Email address domain (example.com) or comma separated list of email domains \n            (example1.com, example2.com) allowed to signin and signup using the web UI.\n            If left empty, signup via the web UI is disabled and users will have to be created using\n            Cognito.\n        AllowedPattern: '^(|([\\w-]+\\.)+[\\w-]{2,6}(, *([\\w-]+\\.)+[\\w-]{2,6})*)$'\n\n    SaveHistory:\n        Type: String\n        Default: false\n        AllowedValues:\n            - true\n            - false\n        Description: >\n            This is an optional parameter, if set to True, the history of the chat is maintained over sessions.\n            A item to clean the chat will appear at the menu.\n\n    ShouldEnableLiveChat:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n          This is an optional parameter, if set to True, the AWS Connect live Chat functionality will be available.\n          A item to start a live chat will appear at the menu.\n\n    CodeBuildName:\n        Type: String\n        Description: >\n            Name of the CodeBuild project to be created. Used to\n            configure and directly deploy the web app to S3. Must be\n            unique per region\n        Default: lex-web-ui\n        MinLength: 2\n        MaxLength: 255\n        AllowedPattern: '^[A-Za-z0-9][A-Za-z0-9\\-_]{1,254}$'\n        ConstraintDescription: >\n            Should start with Alphanumeric. May contain alphanumeric, undescore\n            and dash.\n\n    WebAppParentOrigin:\n        Type: String\n        Description: >\n            Browser origin (e.g. http://mysite.example.com:8080)\n            of an existing site where you want to place the chat bot UI.\n            This is an optional parameter. If left empty, the sample parent page\n            will be hosted in the same S3 bucket as the iframe\n        Default: ''\n        AllowedPattern: '(^$|^https?://[\\w\\.-]+(:\\d+)?$)'\n        ConstraintDescription: Empty or valid browser origin\n\n    WebAppPath:\n        Type: String\n        Default: '/parent.html'\n        Description: >\n            Path to the page (or pages) under WebAppParentOrigin used to host\n            the chatbot UI. Multiple paths can be specified as a comma separated\n            list.\n\n    CognitoIdentityPoolId:\n        Type: String\n        Description: >\n            Id of an existing Cognito Identity Pool. This is an optional\n            parameter. If left empty, a Cognito Identity Pool will be\n            automatically created. The pool ID is used by the web ui\n            to get AWS credentials for making calls to Lex and Polly.\n        Default: ''\n        AllowedPattern: '(^$|^[\\w-]+:[0-9a-f-]+$)'\n        ConstraintDescription: Empty or a valid Cognito Identity Pool ID\n\n    CognitoIdentityPoolName:\n        Type: String\n        Description: >\n            Name of Cognito identity pool to be created to provide\n            AWS credentials to the web ui. Only used if the\n            CognitoIdentityPoolId parameter is left empty (default).\n        Default: Lex Web UI\n        MinLength: 1\n        MaxLength: 128\n        AllowedPattern: '^[\\w ]+$'\n        ConstraintDescription: Alphanumeric and spaces.\n\n    CleanupBuckets:\n        Type: String\n        Default: true\n        AllowedValues:\n          - true\n          - false\n        Description: >\n            If set to True, buckets created for the Pipeline and to store the\n            web application will be deleted on CloudFormation stack delete.\n            If set to False, S3 buckets will be retained.\n\n    EnableMarkdownSupport:\n        Type: String\n        Default: true\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            If set to True, enable optional Markdown formatting.\n            Warning: Improper use of the Markdown/html feature can open you up to a cross-site\n            scripting (XSS) attack from insecure Bots. Make sure you trust the Bot being used\n            by the LexWebUi.\n\n    ReInitSessionAttributesOnRestart:\n        Type: String\n        Default: false\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            If set to True, session attributes sent on each request to Lex are reset. Use a value\n            of false, if session attributes need to be supported on subsequent Lex requests. The\n            default is false.\n\n    ShouldLoadIframeMinimized:\n        Type: String\n        Default: false\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            If set to True and running embedded as an Iframe on a web page, minimize the\n            LexWebUi when first launched. If set to False, the Iframe will be maximized\n            on the hosting page.\n\n    ShowResponseCardTitle:\n        Type: String\n        Default: false\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            If set to True, the ResponseCard title is displayed in the UI. When set to false,\n            a ResponseCard title is not displayed in the UI. Default is false. Note at the\n            present time this is a global setting. Should the UI need to display some form\n            of a title, use the optional sub-title property of a ResponseCard.\n\n    # Sub-templates and source artifacts are hosted in this bucket.\n    # The content of this bucket is maintained outside of this template\n    # by using the Makefile under the build directory of this project.\n    # See the README.md file for instructions on how to use your own bucket.\n    BootstrapBucket:\n        Type: String\n        Default: aws-bigdata-blog\n        Description: >\n            S3 bucket containing pre-staged nested templates and source artifacts\n    BootstrapPrefix:\n        Type: String\n        Default: artifacts/aws-lex-web-ui/artifacts\n        Description: >\n            S3 prefix where the templates and source are stored under\n\n    WebAppConfBotInitialText:\n        Type: String\n        Default: >\n            You can ask me for help ordering flowers. Just type \"Buy\n            flowers\" or click on the mic and say it.\n        Description: First bot message displayed in the chatbot UI\n\n    WebAppConfBotInitialSpeech:\n        Type: String\n        Default: Say 'Buy Flowers' to get started.\n        Description: >\n            Message spoken by bot when the microphone is first pressed in\n            a conversation\n\n    WebAppConfBotInitialUtterance:\n        Type: String\n        Default: ''\n        Description: >\n            Text to use to send as first utterance to bot\n\n    WebAppConfNegativeFeedback:\n        Type: String\n        Default: Thumbs down\n        Description: >\n            This optional parameter defines the message to be sent by the user upon pressing\n            a feedback button signaling a negative feedback.\n            If left empty feedback buttons will be disabled on the UI.\n\n    WebAppConfPositiveFeedback:\n        Type: String\n        Default: Thumbs up\n        Description: >\n            This optional parameter defines the message to be sent by the user upon pressing\n            a feedback button signaling a positive feedback.\n            If left empty feedback buttons will be disabled on the UI.\n\n    WebAppConfHelp:\n        Type: String\n        Default: Help\n        Description: >\n            This is an optional parameter, when defined with a value, a help button will display on the chat bot toolbar.\n            When pressed the button will send the entered string to the bot as a help message.  If left empty\n            the help button will be disabled.\n\n    WebAppConfToolbarTitle:\n        Type: String\n        Default: Order Flowers\n        Description: Title displayed in the chatbot UI toolbar\n\n    WebAppConfCname:\n        Type: String\n        Default: \"\"\n        Description: This optional parameter allows a single CNAME to be defined and used as an alias to\n            the cloudfront distribution that is created by this template. If a CNAME is provided, a\n            WebAppAcmCertificateArn must also be provided.\n\n    WebAppAcmCertificateArn:\n        Type: String\n        Default: \"\"\n        Description: This optional parameter allows a AcmCertificateArn to be provided for use in the Cloudfront\n            distribution created by this template. if a AcmCertificateArn is provided, a WebAppConfCname must also\n            be provided.\n\n    WebAppWafAclArn:\n        Type: String\n        Default: \"\"\n        Description: This optional parameter allows a AWS WAF web ACL to be specified in ARN formation. This supports\n            AWS WAF V2.\n\n    HideButtonMessageBubble:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n         If set to true, hide the message bubble on a response card button press\n    \n    MessageMenu:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n          If set to true, each message will have an additional clickable menu on messages \n          sent to the bot allowing you to repeat that message.\n\n    BackButton:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n          If set to true, will show a back button to go back to a previous message.\n\n    MinimizedButtonContent:\n        Type: String\n        Default: ''\n        Description: >\n          This is an optional parameter, if populated will display provided text when chat window is minimized.\n\n    retryOnLexPostTextTimeout:\n        Type: String\n        Default: false\n        AllowedValues:\n            - true\n            - false\n        Description: >\n            When set to true, operations against the Lex PostText API that result in a timeout\n            will be retried up the the defined retry count. This is useful to enable if 30 second\n            timeouts in Lex are frequently observed and subsequent operations will must likely succeed.\n\n    retryCountPostTextTimeout:\n        Type: Number\n        Default: 1\n        Description: >\n            Defines the number of times the lex-web-ui will retry the Lex PostText API operation when an exception\n            is detected.\n\n    ConnectContactFlowId:\n        Type: String\n        Description: >\n            Connect Contract Flow Id\n        Default: ''\n\n    ConnectInstanceId:\n        Type: String\n        Description: >\n            Connect Instance Id\n        Default: ''\n\n    ConnectPromptForNameMessage:\n        Type: String\n        Description: >\n            Message to display prompting the user for a name\n        Default: Before starting a live chat, please tell me your name?\n\n    ConnectWaitForAgentMessage:\n        Type: String\n        Description: >\n            Message to display every message interval while waiting for an agent to connect\n        Default: Thanks for waiting. An agent will be with you when available.\n\n    ConnectAttachChatTranscript:\n        Type: String\n        Default: false\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            Attach chat transcript as file. This only works if you enable attachments in Amazon Connect.\n\n    ConnectAgentJoinedMessage:\n        Type: String\n        Description: >\n            Message to play when an agent joins the chat. {Agent} will be replaced with the Agent's name.\n        Default: \"{Agent} has joined.\"\n\n    ConnectAgentLeftMessage:\n        Type: String\n        Description: >\n            Message to play when an agent leaves the chat. {Agent} will be replaced with the Agent's name.\n        Default: \"{Agent} has left.\"\n    \n    ConnectChatEndedMessage:\n        Type: String\n        Description: >\n            Message to play when a chat session has ended.\n        Default: \"Chat ended.\"\n\n    ConnectWaitForAgentMessageIntervalInSeconds:\n        Type: Number\n        Description: >\n            Interval in seconds between successive ConnectWaitForAgentMessage. 0 to disable interval.\n        Default: 60\n\n    ConnectLiveChatTerms:\n        Type: String\n        Description: >\n            Command separated list of terms that can be used to start Live Chat mode\n        Default: \"live chat\"\n\n    ConnectTranscriptMessageDelayInMsec:\n        Type: Number\n        Description: >\n            Delay to insert between each transcript message send to Connect in msec.\n        Default: 150\n\n    ConnectStartLiveChatLabel:\n        Type: String\n        Description: >\n            Label used in Menu to start connect live chat\n        Default: \"Start Live Chat\"\n\n    ConnectStartLiveChatIcon:\n        Type: String\n        Description: >\n            Icon to use in menu to start connect live chat\n        Default: \"people_alt\"\n\n    ConnectEndLiveChatLabel:\n        Type: String\n        Description: >\n            Label to use in menu and toolbar to end connect live chat\n        Default: \"End Live Chat\"\n\n    ConnectEndLiveChatIcon:\n        Type: String\n        Description: >\n            Icon to use in menu and toolbar to end connect live chat\n        Default: \"call_end\"\n\n    ConnectEndLiveChatUtterance:\n        Type: String\n        Description: >\n            Optional utterance to send to bot after ending a live chat session\n        Default: ''\n\n    ConnectTranscriptRedactRegex:\n        Type: String\n        Description: >\n            Optional regex used to redact entire lines in transcript sent to agent\n        Default: ''\n\n    ## CSS Configuration Options\n    MessageTextColor:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the color of the message text, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n\n    MessageFont:\n        Type: String\n        Default: ''\n        Description: >\n         Sets the font style of the messages sent by the agent and customer\n\n    ChatBackgroundColor:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the background color of the message area, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n\n    ToolbarColor:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the background color of the toolbar, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n\n    BotChatBubble:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the background color of the bubble for the bot, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n    \n    CustomerChatBubble:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the background color of the bubble for the customer, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n\n    MinimizedButtonColor:\n        Type: String\n        Default: ''\n        Description: >\n         Optional parameter, leave empty to retain previous settings. \n         Sets the background color of the button displayed when the chat is minimized, can be a valid CSS color (red, green, etc) or Hex value (#FF0000, #ADD8E6, etc)\n\n    TitleLogoImgUrl:\n        Type: String\n        Description: >\n         This is an optional parameter, when set to an image URL that is accessible by the application it will \n         display the image left of the toolbar title. Image must be formatted to the correct size for display.\n\n    BotAvatarImgUrl:\n        Type: String\n        Description: >\n         This is an optional parameter, when set to an image URL that is accessible by the application it will \n         display on the left of all bot messages\n\n    AllowStreamingResponses:\n        Type: String\n        Default: false\n        AllowedValues:\n        - true\n        - false\n        Description: >\n            If set to True, a websocket API Gateway will be established and messages will be sent to this web socket\n            in addition to the Lex bot directly. More details on how to configure your bot for streaming intereactions\n            can be found here: https://github.com/aws-samples/aws-lex-web-ui/blob/master/README-streaming-responses.md\n\n    StreamingWebSocketEndpoint:\n        Type: String\n        Default: ''\n        Description: >\n            If you have an existing WebSocket API Gateway endpoint, you can specify it using this parameter. This requires parameter AllowStreamingResponses set to True.\n    \n    ShouldEnableUpload:\n        Type: String\n        Default: false\n        AllowedValues:\n          - true\n          - false\n        Description: >\n          If set to True, the upload document functionality will be available. The icon for uploading documents\n          will appear in the UI and an API Gateway endpoint will be deployed for generating pre-signed URLs for the UI\n          to utilize for uploading documents. By default, pre-signed URLs have a TTL of 60 seconds.\n\n    UploadBucket:\n        Type: String\n        Default: ''\n        Description: >\n            If enabling upload, the name of the S3 bucket where uploaded documents should be stored\n\n    AmazonQAppId:\n        Type: String\n        Default: ''\n        Description: Amazon Q Application ID. This option will automatically create a bot and the V1/V2 bot fields should be left blank.\n\n    IDCApplicationARN:\n        Type: String\n        Default: ''\n        Description: >\n            ARN of the Identity Center customer managed application created for QBusiness. This will need to be configured\n            manually after initial UI deployment. The value from manual creation will need to be supplied here and the template updated.\n            This process is not automated because in many use cases Identity Center will not be in the same account as the bot.\n            Manual set-up instructions can be found here: https://github.com/aws-samples/aws-lex-web-ui/blob/master/README-qbusiness.md\n\n    VpcSubnetId:\n        Type: String\n        Default: ''\n        Description: ID of a VPC subnet where all Lambda functions will run, only used if you need Lambda to run in a VPC\n\n    VpcSecurityGroupId:\n        Type: String\n        Default: ''\n        Description: ID of a security group where all Lambda functions will run, only used if you need Lambda to run in a VPC\n\n    \nRules:\n  ValidateEitherV1orV2:\n    RuleCondition: !Not \n        - !Equals\n            - !Ref BotName\n            - ''\n    Assertions:\n      - Assert: !Equals \n            - !Ref LexV2BotId\n            - ''\n        AssertDescription: 'Template cannot contain both Lex V1 and Lex V2 information'\n\nMetadata:\n    AWS::CloudFormation::Interface:\n        ParameterGroups:\n            - Label:\n                default: Deployment Parameters\n              Parameters:\n                  - CodeBuildName\n                  - CleanupBuckets\n                  - BootstrapBucket\n                  - BootstrapPrefix\n            - Label:\n                default: Lex V1 Bot Configuration Parameters\n              Parameters:\n                  - BotName\n                  - BotAlias\n            - Label:\n                default: Lex V2 Bot Configuration Parameters\n              Parameters:\n                  - LexV2BotId\n                  - LexV2BotAliasId\n                  - LexV2BotLocaleId\n            - Label:\n                default: Optional Sample Bot\n              Parameters:\n                  - ShouldDeleteBot\n            - Label:\n                default: Bot Behavior Parameters\n              Parameters:\n                  - EnableCognitoLogin\n                  - ForceCognitoLogin\n                  - AllowedSignUpEmailDomain\n                  - EnableMarkdownSupport\n                  - ReInitSessionAttributesOnRestart\n                  - ShowResponseCardTitle\n                  - SaveHistory\n                  - retryOnLexPostTextTimeout\n                  - retryCountPostTextTimeout\n                  - AllowStreamingResponses\n                  - StreamingWebSocketEndpoint\n                  - ShouldEnableUpload\n                  - UploadBucket\n            - Label:\n                default: Cognito Parameters\n              Parameters:\n                  - CognitoIdentityPoolId\n                  - CognitoIdentityPoolName\n            - Label:\n                default: Web Application Parameters\n              Parameters:\n                  - WebAppParentOrigin\n                  - WebAppPath\n                  - WebAppConfBotInitialText\n                  - WebAppConfBotInitialSpeech\n                  - WebAppConfBotInitialUtterance\n                  - WebAppConfNegativeFeedback\n                  - WebAppConfPositiveFeedback\n                  - WebAppConfHelp\n                  - WebAppAcmCertificateArn\n                  - WebAppConfCname\n                  - WebAppWafAclArn\n                  - HideButtonMessageBubble\n                  - MessageMenu\n                  - BackButton\n                  - MinimizedButtonContent\n                  - WebAppConfToolbarTitle\n                  - ShouldLoadIframeMinimized\n                  - TitleLogoImgUrl\n                  - BotAvatarImgUrl\n            - Label:\n                default: Connect Live Chat Parameters\n              Parameters:\n                  - ShouldEnableLiveChat\n                  - ConnectLiveChatTerms\n                  - ConnectInstanceId\n                  - ConnectContactFlowId\n                  - ConnectPromptForNameMessage\n                  - ConnectWaitForAgentMessage\n                  - ConnectWaitForAgentMessageIntervalInSeconds\n                  - ConnectAgentJoinedMessage\n                  - ConnectAgentLeftMessage\n                  - ConnectChatEndedMessage\n                  - ConnectAttachChatTranscript\n                  - ConnectStartLiveChatLabel\n                  - ConnectStartLiveChatIcon\n                  - ConnectEndLiveChatLabel\n                  - ConnectEndLiveChatIcon\n                  - ConnectEndLiveChatUtterance\n                  - ConnectTranscriptMessageDelayInMsec\n                  - ConnectTranscriptRedactRegex\n            - Label:\n                default: CSS Customization Parameters\n              Parameters:\n                  - MessageTextColor\n                  - MessageFont\n                  - ChatBackgroundColor\n                  - ToolbarColor\n                  - BotChatBubble\n                  - CustomerChatBubble\n                  - MinimizedButtonColor\n            - Label:\n                default: Lambda VPC Support\n              Parameters:\n                  - VpcSubnetId\n                  - VpcSecurityGroupId \n            - Label:\n                default: Q Business Parameters\n              Parameters:\n                  - AmazonQAppId\n                  - IDCApplicationARN\n\nConditions:\n    IsLexV2: !Not [ !Equals [!Ref LexV2BotId, ''] ]\n    NeedsBot:  !And [ !Equals [!Ref BotName, ''], !Equals [!Ref LexV2BotId, ''] ]\n    NeedsVpc:  !And [ !Not [ !Equals [!Ref VpcSubnetId, ''] ], !Not [ !Equals [!Ref VpcSecurityGroupId, ''] ] ] \n    NeedsCognito: !Equals [!Ref CognitoIdentityPoolId, '']\n    NeedsParentOrigin: !Equals [!Ref WebAppParentOrigin, '']\n    ShouldForceCognitoLogin: !Equals [!Ref ForceCognitoLogin, true]\n    EnableLiveChat: !Equals [!Ref ShouldEnableLiveChat, true]\n\nResources:\n    Bot:\n        Type: AWS::CloudFormation::Stack\n        Condition: NeedsBot\n        Properties:\n            TimeoutInMinutes: 15\n            TemplateURL: !Sub \"https://${BootstrapBucket}.s3.${AWS::Region}.amazonaws.com/${BootstrapPrefix}/templates/lexbot.yaml\"\n            Parameters:\n                ShouldDeleteBot: !Ref ShouldDeleteBot\n                ParentStackName: !Ref \"AWS::StackName\"\n                SourceBucket: !Ref BootstrapBucket\n                QBusinessLambdaCodeObject: !Sub \"${BootstrapPrefix}/qbusiness-lambda-v0.22.5.zip\"\n                AmazonQAppId: !Ref AmazonQAppId\n                IDCApplicationARN: !Ref IDCApplicationARN\n                VpcSubnetId: !Ref VpcSubnetId\n                VpcSecurityGroupId: !Ref VpcSecurityGroupId\n\n    CognitoIdentityPool:\n        Type: AWS::CloudFormation::Stack\n        Condition: NeedsCognito\n        Properties:\n            TemplateURL: !Sub \"https://${BootstrapBucket}.s3.${AWS::Region}.amazonaws.com/${BootstrapPrefix}/templates/cognito.yaml\"\n            Parameters:\n                CognitoIdentityPoolName: !Ref CognitoIdentityPoolName\n                ForceCognitoLogin: !Ref ForceCognitoLogin\n                LexV2BotId:\n                    !If\n                      - NeedsBot\n                      - !GetAtt Bot.Outputs.BotId\n                      - !Ref LexV2BotId\n                LexV2BotAliasId:\n                    !If\n                      - NeedsBot\n                      - !GetAtt Bot.Outputs.BotAlias\n                      - !Ref LexV2BotAliasId\n                ShouldEnableLiveChat: !Ref ShouldEnableLiveChat\n                ShouldEnableUpload: !Ref ShouldEnableUpload\n                UploadBucket: !Ref UploadBucket\n                AllowStreamingResponses: !Ref AllowStreamingResponses\n                AllowedSignUpEmailDomain: !Ref AllowedSignUpEmailDomain\n\n    ##########################################################################\n    # Simplified deployment using CodeBuild to build config and push to S3\n    ##########################################################################\n    CodeBuildDeploy:\n        Type: AWS::CloudFormation::Stack\n        Properties:\n            TemplateURL: !Sub \"https://${BootstrapBucket}.s3.${AWS::Region}.amazonaws.com/${BootstrapPrefix}/templates/codebuild-deploy.yaml\"\n            Parameters:\n                ResourcePrefix: !Ref \"AWS::StackName\"\n                CodeBuildName: !Ref CodeBuildName\n                SourceBucket: !Ref BootstrapBucket\n                SourcePrefix: !Ref BootstrapPrefix\n                StreamingWebSocketEndpoint: !Ref StreamingWebSocketEndpoint\n                SourceObject: !Sub \"${BootstrapPrefix}/src-v0.22.5.zip\"\n                CustomResourceCodeObject: !Sub \"${BootstrapPrefix}/custom-resources-v0.22.5.zip\"\n                InitiateChatLambdaCodeObject: !Sub \"${BootstrapPrefix}/initiate-chat-lambda-v0.22.5.zip\"\n                StreamingLambdaCodeObject: !Sub \"${BootstrapPrefix}/streaming-lambda-v0.22.5.zip\"\n                CleanupBuckets: !Ref CleanupBuckets\n                LexV2BotId:\n                    !If\n                      - NeedsBot\n                      - !GetAtt Bot.Outputs.BotId\n                      - !Ref LexV2BotId\n                LexV2BotAliasId:\n                    !If\n                      - NeedsBot\n                      - !GetAtt Bot.Outputs.BotAlias\n                      - !Ref LexV2BotAliasId\n                LexV2BotLocaleId: !Ref LexV2BotLocaleId\n                CognitoIdentityPoolId:\n                    !If\n                      - NeedsCognito\n                      - !GetAtt CognitoIdentityPool.Outputs.CognitoIdentityPoolId\n                      - !Ref CognitoIdentityPoolId\n                ParentOrigin: !Ref WebAppParentOrigin\n                WebAppConfBotInitialText: !Ref WebAppConfBotInitialText\n                WebAppConfBotInitialSpeech: !Ref WebAppConfBotInitialSpeech\n                WebAppConfBotInitialUtterance: !Ref WebAppConfBotInitialUtterance\n                WebAppConfNegativeFeedback: !Ref WebAppConfNegativeFeedback\n                WebAppConfPositiveFeedback: !Ref WebAppConfPositiveFeedback\n                WebAppConfHelp: !Ref WebAppConfHelp\n                WebAppConfCname: !Ref WebAppConfCname\n                WebAppAcmCertificateArn: !Ref WebAppAcmCertificateArn\n                WebAppWafAclArn: !Ref WebAppWafAclArn\n                HideButtonMessageBubble: !Ref HideButtonMessageBubble\n                MessageMenu: !Ref MessageMenu\n                BackButton: !Ref BackButton\n                MinimizedButtonContent: !Ref MinimizedButtonContent\n                WebAppConfToolbarTitle: !Ref WebAppConfToolbarTitle\n                SaveHistory: !Ref SaveHistory\n                ShouldEnableLiveChat: !Ref ShouldEnableLiveChat\n                ShouldEnableCognitoLogin:\n                  !If\n                    - ShouldForceCognitoLogin\n                    - true\n                    - !Ref EnableCognitoLogin\n                ShouldForceCognitoLogin: !Ref ForceCognitoLogin\n                ReInitSessionAttributesOnRestart: !Ref ReInitSessionAttributesOnRestart\n                EnableMarkdownSupport: !Ref EnableMarkdownSupport\n                ShouldLoadIframeMinimized: !Ref ShouldLoadIframeMinimized\n                ShowResponseCardTitle: !Ref ShowResponseCardTitle\n                CognitoAppUserPoolClientId:\n                    !If\n                      - NeedsCognito\n                      - !GetAtt CognitoIdentityPool.Outputs.CognitoUserPoolClientId\n                      - \"UserMustSupply\"\n                CognitoUserPoolId:\n                    !If\n                      - NeedsCognito\n                      - !GetAtt CognitoIdentityPool.Outputs.CognitoUserPoolId\n                      - \"UserMustSupply\"\n                retryOnLexPostTextTimeout: !Ref retryOnLexPostTextTimeout\n                retryCountPostTextTimeout: !Ref retryCountPostTextTimeout\n                ConnectContactFlowId: !Ref ConnectContactFlowId\n                ConnectInstanceId: !Ref ConnectInstanceId\n                ConnectPromptForNameMessage: !Ref ConnectPromptForNameMessage\n                ConnectWaitForAgentMessage: !Ref ConnectWaitForAgentMessage\n                ConnectWaitForAgentMessageIntervalInSeconds: !Ref ConnectWaitForAgentMessageIntervalInSeconds\n                ConnectAgentJoinedMessage: !Ref ConnectAgentJoinedMessage\n                ConnectAgentLeftMessage: !Ref ConnectAgentLeftMessage\n                ConnectChatEndedMessage: !Ref ConnectChatEndedMessage\n                ConnectAttachChatTranscript: !Ref ConnectAttachChatTranscript\n                ConnectLiveChatTerms: !Ref ConnectLiveChatTerms\n                ConnectStartLiveChatLabel: !Ref ConnectStartLiveChatLabel\n                ConnectStartLiveChatIcon: !Ref ConnectStartLiveChatIcon\n                ConnectEndLiveChatLabel: !Ref ConnectEndLiveChatLabel\n                ConnectEndLiveChatIcon: !Ref ConnectEndLiveChatIcon\n                ConnectEndLiveChatUtterance: !Ref ConnectEndLiveChatUtterance\n                ConnectTranscriptMessageDelayInMsec: !Ref ConnectTranscriptMessageDelayInMsec\n                ConnectTranscriptRedactRegex: !Ref ConnectTranscriptRedactRegex\n                MessageTextColor: !Ref MessageTextColor\n                MessageFont: !Ref MessageFont\n                ChatBackgroundColor: !Ref ChatBackgroundColor\n                ToolbarColor: !Ref ToolbarColor\n                BotChatBubble: !Ref BotChatBubble\n                CustomerChatBubble: !Ref CustomerChatBubble\n                MinimizedButtonColor: !Ref MinimizedButtonColor\n                TitleLogoImgUrl: !Ref TitleLogoImgUrl\n                BotAvatarImgUrl: !Ref BotAvatarImgUrl\n                AllowStreamingResponses: !Ref AllowStreamingResponses\n                ShouldEnableUpload: !Ref ShouldEnableUpload\n                UploadBucket: !Ref UploadBucket\n                VpcSubnetId: !Ref VpcSubnetId\n                VpcSecurityGroupId: !Ref VpcSecurityGroupId\n                Timestamp: 1757519732\n\n    CognitoIdentityPoolConfig:\n        Type: AWS::CloudFormation::Stack\n        Condition: NeedsCognito\n        Properties:\n            TemplateURL: !Sub \"https://${BootstrapBucket}.s3.${AWS::Region}.amazonaws.com/${BootstrapPrefix}/templates/cognitouserpoolconfig.yaml\"\n            Parameters:\n                CloudFrontUrl: !GetAtt CodeBuildDeploy.Outputs.WebAppBase\n                WebAppUrl: !Ref WebAppParentOrigin\n                WebAppPath: !Ref WebAppPath\n                CodeBuildProjectName: !GetAtt CodeBuildDeploy.Outputs.CodeBuildProject\n                CognitoUserPool: !GetAtt CognitoIdentityPool.Outputs.CognitoUserPoolId\n                CognitoUserPoolClient: !GetAtt CognitoIdentityPool.Outputs.CognitoUserPoolClientId\n                VpcSubnetId: !Ref VpcSubnetId\n                VpcSecurityGroupId: !Ref VpcSecurityGroupId\n                Timestamp: 1757519732\n\n    ##########################################################################\n    # Lambda that will validate if user has put in an invalid CSS color/Hex string and fail deployment\n    ##########################################################################\n    CSSValidationLambda:\n        Type: AWS::Lambda::Function       \n        Properties:\n            VpcConfig:\n                !If\n                - NeedsVpc\n                - \n                    SecurityGroupIds:\n                        - !Ref VpcSecurityGroupId\n                    SubnetIds:\n                        - !Ref VpcSubnetId\n                - !Ref \"AWS::NoValue\"\n            Description: 'Lambda invoke wrapper for Custom CFN actions'\n            Code:\n                ZipFile: !Sub |\n                    import re\n                    import cfnresponse\n\n                    def handler(event, context):\n                        responseData = {}\n                        try:\n                            if event['RequestType'] == \"Create\" or event['RequestType'] == \"Update\":\n                                colors = ['aqua', 'black', 'blue', 'fuchsia', 'gray', 'green', 'lime', 'maroon', 'navy', 'olive', 'purple', 'red', 'silver', 'teal', 'white', 'yellow']\n                                                                \n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${MessageTextColor}\")) and (not \"${MessageTextColor}\" in colors) and (\"${MessageTextColor}\".strip()):\n                                    responseData['Data'] = \"${MessageTextColor}\" + \" is not a valid color or HEX code\"\n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${ChatBackgroundColor}\")) and (not \"${ChatBackgroundColor}\" in colors) and (\"${ChatBackgroundColor}\".strip()):\n                                    responseData['Data'] = \"${ChatBackgroundColor}\" + \" is not a valid color or HEX code\"                                \n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${ToolbarColor}\")) and (not \"${ToolbarColor}\" in colors) and (\"${ToolbarColor}\".strip()):\n                                    responseData['Data'] = \"${ToolbarColor}\" + \" is not a valid color or HEX code\"                                                                \n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${BotChatBubble}\")) and (not \"${BotChatBubble}\" in colors) and (\"${BotChatBubble}\".strip()):              \n                                    responseData['Data'] = \"${BotChatBubble}\" + \" is not a valid color or HEX code\"                                                                \n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${CustomerChatBubble}\")) and (not \"${CustomerChatBubble}\" in colors) and (\"${CustomerChatBubble}\".strip()):\n                                    responseData['Data'] = \"${CustomerChatBubble}\" + \" is not a valid color or HEX code\"                                                                \n                                if (not re.search(r'^#(?:[0-9a-fA-F]{3}){1,2}$', \"${MinimizedButtonColor}\")) and (not \"${MinimizedButtonColor}\" in colors) and (\"${MinimizedButtonColor}\".strip()):\n                                    responseData['Data'] = \"${MinimizedButtonColor}\" + \" is not a valid color or HEX code\" \n                                    \n                                if 'Data' in responseData:\n                                    cfnresponse.send(event, context, cfnresponse.FAILED, responseData, 'scm-cfn-customresource-id', False, responseData['Data'])\n                                else:\n                                    responseData['Data'] = \"CSS Validation Complete\"\n                                    cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, 'scm-cfn-customresource-id')\n                            else:\n                                responseData['Data'] = \"CSS Validation Delete Complete\"\n                                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData, 'scm-cfn-customresource-id')\n                        except:\n                            responseData['Data'] = \"Unknown error when validating CSS colors\"\n                            cfnresponse.send(event, context, cfnresponse.FAILED, responseData, 'scm-cfn-customresource-id', False, responseData['Data']) \n                        \n            Handler: index.handler\n            Role: !GetAtt CSSValidationLambdaRole.Arn\n            Runtime: python3.10\n            Timeout: 60\n\n    CSSValidationLambdaRole:\n        Type: AWS::IAM::Role\n        Properties:\n            Path: /\n            ManagedPolicyArns:\n                !If \n                  - NeedsVpc\n                  -\n                    - \"arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole\"\n                  - !Ref \"AWS::NoValue\"\n            AssumeRolePolicyDocument:\n                Version: 2012-10-17\n                Statement:\n                    - Principal:\n                          Service:\n                              - lambda.amazonaws.com\n                      Effect: Allow\n                      Action:\n                          - sts:AssumeRole\n            Policies:\n                - PolicyName: LogsForLambda\n                  PolicyDocument:\n                      Version: 2012-10-17\n                      Statement:\n                          - Effect: Allow\n                            Action:\n                                - logs:CreateLogGroup\n                                - logs:CreateLogStream\n                                - logs:PutLogEvents\n                            Resource:\n                                - !Sub \"arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*\"\n                                - !Sub \"arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*:*\"\n                        \n    CSSValidationLambdaInvoker:\n        Type: AWS::CloudFormation::CustomResource\n        DependsOn: CSSValidationLambda\n        Version: \"1.0\"\n        Properties:\n            ServiceToken: !GetAtt CSSValidationLambda.Arn\n            ServiceTimeout: 60\n            MessageTextColor: !Ref MessageTextColor\n            ChatBackgroundColor: !Ref ChatBackgroundColor\n            ToolbarColor: !Ref ToolbarColor\n            BotChatBubble: !Ref BotChatBubble\n            CustomerChatBubble: !Ref CustomerChatBubble\n            MinimizedButtonColor: !Ref MinimizedButtonColor\n            \nOutputs:\n    BotName:\n        Condition: NeedsBot\n        Description: >\n            Name of the Lex bot created by the stack\n        Value: !GetAtt Bot.Outputs.BotId\n\n    QBusinessLambdaRoleARN:\n        Condition: NeedsBot\n        Value: !GetAtt Bot.Outputs.QBusinessLambdaRoleARN\n        Description: ARN of role created for executing the Q Business Lambda fulfillment function\n\n    CodeBuildUrl:\n        Description: >\n            Monitor the pipeline URL to see when the application has been fully\n            built and deployed.\n        Value: !Sub \"https://console.aws.amazon.com/codebuild/home?region=${AWS::Region}#/projects/${CodeBuildDeploy.Outputs.CodeBuildProject}/view\"\n\n    WebAppUrl:\n        Description: >\n            URL of the stand-alone sample web application.\n            This page will be available after the pipeline/deployment completes.\n        Value: !GetAtt CodeBuildDeploy.Outputs.WebAppUrl\n\n    WebAppDomainName:\n        Description: >\n            DomainName of the web application\n        Value: !GetAtt CodeBuildDeploy.Outputs.WebAppDomainName\n        Export:\n          Name: !Join [\":\", [!Ref \"AWS::StackName\", WebAppDomainName]]\n\n    WebAppBucket:\n        Description: >\n            S3 bucket hosting lexwebui artifacts\n        Value: !GetAtt CodeBuildDeploy.Outputs.WebAppBucket\n        Export:\n          Name: !Join [\":\", [!Ref \"AWS::StackName\", WebAppBucket]]\n\n    ParentPageUrl:\n        Condition: NeedsParentOrigin\n        Description: >\n            URL of the iframe based sample web application\n            This page will be available after the pipeline/deployment completes.\n        Value: !GetAtt CodeBuildDeploy.Outputs.ParentPageUrl\n\n    LoaderScriptUrl:\n        Description: >\n            URL of the loader script\n            This script will be available after the pipeline/deployment completes.\n        Value: !GetAtt CodeBuildDeploy.Outputs.LoaderScriptUrl\n\n    SnippetUrl:\n        Description: >\n            URL of a page showing the snippet to load the chatbot UI as\n            an iframe\n        Value: !GetAtt CodeBuildDeploy.Outputs.SnippetUrl\n\n    CognitoIdentityPoolId:\n        Condition: NeedsCognito\n        Description: Cognito Identity Pool Id\n        Value: !GetAtt CognitoIdentityPool.Outputs.CognitoIdentityPoolId\n\n    CognitoUserPoolPubKey:\n        Condition: NeedsCognito\n        Description: Include Cognito User Pool Public Key URL in stack outputs (needed for QnABot token auth)\n        Value: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoIdentityPool.Outputs.CognitoUserPoolId}/.well-known/jwks.json\n\n    CognitoUserPoolClientId:\n        Condition: NeedsCognito\n        Description: Cognito User Pool Client Id\n        Value: !GetAtt CognitoIdentityPool.Outputs.CognitoUserPoolClientId\n        Export:\n          Name: !Join [\":\", [!Ref \"AWS::StackName\", CognitoUserPoolClientId]]\n\n",
    "StagesAvailable": [
        "Original",
        "Processed"
    ]
}
